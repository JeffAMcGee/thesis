%File: formatting-instruction.tex
\documentclass[letterpaper]{article}
\usepackage{aaai}
\usepackage{times}
\usepackage{helvet}
\usepackage{courier}
\usepackage{subfigure}
%\usepackage{multirow}
\usepackage[hyphens]{url}
\usepackage{graphicx}
%\usepackage[small,it]{caption}
\usepackage[noend]{algpseudocode}
\usepackage{algorithm}
%\usepackage{algorithmic}
\usepackage{amsmath}

%\usepackage{algorithm}
\DeclareMathOperator{\pContact}{pContact}
\DeclareMathOperator{\pLocation}{pContact}
\DeclareMathOperator{\pTimeZone}{pTimeZone}
\DeclareMathOperator{\pStrangers}{pStrangers}
\DeclareMathOperator{\edges}{edges}
\DeclareMathOperator{\contactEdges}{contactEdges}
\DeclareMathOperator{\actEdges}{actEdges}
\DeclareMathOperator{\median}{median}
\DeclareMathOperator{\PLE}{PLE}
\DeclareMathOperator{\LCR}{LCR}
\DeclareMathOperator{\FriendLoc}{FriendLoc}
\DeclareMathOperator{\Backstrom}{Backstrom}
\DeclareMathOperator{\p}{p}
\DeclareMathOperator{\haversin}{haversin}
\DeclareMathOperator{\Err}{Err}
\DeclareMathOperator{\AED}{AED}
\DeclareMathOperator{\ACC}{ACC}
\DeclareMathOperator{\quantile}{quantile}
\DeclareMathOperator*{\argmax}{arg\,max}
\renewcommand{\algorithmicthen}{}

\hyphenation{Four-square}
\hyphenation{Face-book}

\pdfpagewidth 8.5in \pdfpageheight 11in

\newcommand{\squishlist}{
\begin{list}
	{$\bullet$} { \setlength{
	\itemsep}{0pt} \setlength{\parsep}{3pt} \setlength{\topsep}{3pt} \setlength{
	\partopsep}{0pt} \setlength{\leftmargin}{1.5em} \setlength{\labelwidth}{1em} \setlength{\labelsep}{0.5em} } }
	
	\newcommand{\squishlisttwo}{
	\begin{list}
		{$\bullet$} { \setlength{
		\itemsep}{0pt} \setlength{\parsep}{0pt} \setlength{\topsep}{0pt} \setlength{
		\partopsep}{0pt} \setlength{\leftmargin}{2em} \setlength{\labelwidth}{1.5em} \setlength{\labelsep}{0.5em} } }
		
		\newcommand{\squishend}{
	\end{list}
	}


\frenchspacing
\pdfinfo{
/Title (Formatting Instructions for Authors Using LaTeX)
/Subject (AAAI Publications)
/Author (AAAI Press)}
\setcounter{secnumdepth}{0}
 \begin{document}

\title{FriendlyLocation: Predicting Locations in Social Media Using Tie Strength}

\maketitle
\begin{abstract}
We propose a novel network-based approach for location estimation in social media that integrates evidence of the \textit{social tie strength} between users for improved location estimation. Concretely, we propose a location estimator -- FriendlyLocation -- that leverages the relationship between the strength of the tie between a pair of users, and the distance between the pair. Based on an examination of over 100 million geo-encoded tweets and 73 million user profiles collected from Twitter, we identify several factors such as the number of followers and how the users interact that can strongly reveal the distance between a pair of users, and use these factors to train a decision tree to distinguish between users who are likely to live nearby and pairs of users who are likely to live in different areas. We use the results of this decision tree as the input to a maximum likelihood estimator to predict a user's location. We find that this proposed method significantly improves the results of location estimation relative to a state-of-the-art technique. Our system reduces the average error distance for 80\% of Twitter users from 40 miles to 21 miles using only information from the user's friends and friends-of-friends,  which has great significance for augmenting traditional social media and enriching location-based services with more refined and accurate location estimates.
\end{abstract}

\section{Introduction}
Location-based social media is widespread, with the adoption of voluntary user-based location sharing via ``check-in'' services like Foursquare, geo-tagged posts on Twitter, and photos shared on Flickr and Instagram. These services allow users to annotate their activities with a location field, ranging from a broad descriptor like ``New York'' or ``USA'' to an extremely granular latitude/longitude pair  derived from the GPS capabilities of modern smartphones. Millions of users have already adopted these location sharing services, providing an unprecedented \textit{geographical perspective} on the trails and connections among millions of social media users. 

By investigating the interplay between geography and social media, both researchers and practitioners are enabling new applications that leverage location. Location information is increasingly incorporated into social media for providing localized content, location-aware recommendations, and other geo-spatial enabled services. For example, researchers have begun investigating techniques to cluster users based on their revealed geographic patterns \cite{ADD CITE}, automatically deriving location-based social networks \cite{ADD CITE}, and improving friend suggestion based on geographic proximity. Localized social media activity -- like Twitter discussions about a recent city council vote -- can be automatically detected and directed to interested parties. Crowds of co-located people can be identified and related support services can be directed toward them -- in the case of a fire or emergency, resources may be more smartly targeted to the affected regions. 

Tempering this excitement, however is a key challenge: how to derive high-quality location estimates for users in social media. Many users choose not to reveal their location, while others may reveal their location only using noisy or overly general descriptors (e.g., `` New York'').  To tackle this challenge, one of the most popular location estimation methods is \textit{network-based estimation}, in which a user's location is derived from the known location  properties of other users nearby in the social network (e.g,. if most of my direct friends are in San Francisco, then perhaps I am as well) \cite{ADD CITESHERE}. One of the best known network-based approaches was introduced by Facebook researchers Backstrom et al. \cite{backstrom2010find} in a comprehensive study over XXX million Facebook users. This Facebook study analyzed users who had posted a home street address and found that as distance increases, the probability of friendship decreases. Building on this observational study of Facebook users, they showed how the locations of a user's friends could be used to predict a user's street address with [HIGH PRECISION?]. 

While an encouraging first step, this Facebook approach may encounter difficulties in location estimation when applied more broadly to other social media services: 

\begin{itemize}
\item \textit{Multiple (often imprecise) location granularities.} First, many users in social media reveal broad, imprecise locations (e.g., at the city or state level), while others provide fine-grained latitude-longitude information. How can these multiple location granularities be integrated to account for uncertainty at different levels? 
\item \textit{Varying social ties.} Second, not all relationships in social media are the same. Some ties are stronger than others, and presumably some ties are more revealing of a user's location. How does this variable tie strength nature impact location estimation? 
\item \textit{Conflicting purposes.} Finally, many social systems serve different purposes. Twitter, for example, is both a social network connecting friends (which may tend to be local) as well as a news media (supporting global dissemination)  \cite{kwak2010why}. What is the appropriate balance between these conflicting purposes for location estimation?
\end{itemize}


To address these challenges, we propose a novel network-based approach for location estimation that integrates evidence of the \textit{social tie strength} between users for improved location estimation, naturally incorporates uncertainty across multiple location granularities, and can distinguish between users of the system that operate at cross-purposes. We investigate this approach through an examination of over 100 million geo-encoded tweets and 73 million user profiles collected from Twitter. Concretely, we proposes a location estimator -- FriendlyLocation -- and investigate the relationship between the strength of the tie between a pair of users and the distance between the pair. Based on this investigation, we identify several factors such as number of followers and how the users interact that can strongly reveal the distance between a pair of users, and use these factors to train a tree classifier to predict the distance between a pair of connected users. We use the results of this classifier as the input to a maximum likelihood estimator to predict a user's location. We find that this proposed method significantly improves the results of location estimation relative to the Facebook technique. FriendlyLocation improves the average error distance for 80\% of Twitter users from 41 miles to 21 miles which has great significance for augmenting traditional social media and enriching location-based services with more refined and accurate location estimates.

\section{Related Work}
The study of geographical properties of online social media users has drawn intensive attention in recent years. Characterizing network properties in relation to local geography has been studied in \cite{yardi2010tweeting}. Lindqvist \cite{lindqvist2011m} analyzed how and why people use location sharing services, and discussed the privacy issues related to location sharing services.  User behavior with regard to the location field in Twitter user profiles has been studied in \cite{hecht2011tweets}.

Scellato et al. \cite{scellato2011socio} used data from three location based social networks to investigate the relationship between distance and location, and they show that connections are not purely caused by geographical or social factors.  They investigated two random models where they shuffle the user locations and another where they shuffle the social connections and investigate what happens to the user location.  They show that if a user has more connections, then their friends tend to be further away.  They also found that longer connections are equally likely to be part of a social triangle as shorter connections.

Several researchers in recent years have looked into predicting user locations in a social network based on the social graph. In the best-known paper on this subject, Facebook researchers analyzed the physical distance between Facebook users' social relations and utilized the locations of a user's friends' to predict the user's geographical location \cite{backstrom2010find}. Davis et all. \cite{davis2011infer} investigated a system that predicted location by taking a vote among the locations of the user's friends and picking the most popular location.

An alternative to network-based approaches is \textit{content-based}, in which a the content associated with a user either explicitly reveals location information (e.g,. mentioning a local attraction like Disneyland) or implicitly does so (e.g., by inferring subtle local linguistic cues to estimate a user's location). Cheng et al. \cite{cheng2010you} proposed a content-based system for locating users on Twitter. They find words that are highly concentrated in specific regions and build a model to calculate the probability that a user lives at a location. [ANOTHER ONE?] Recently, Li et al. \cite{li2012towards} proposed a system to integrate both network and content-based estimation via a unified discriminative influence model which combined locations that a Twitter user mentioned with the locations of the user's followers.

[ADD WSDM PAPER] 

Finally, Cranshaw et al. \cite{cranshaw2010bridging} solved the inverse of the problem we are investigating: they predicted the existence of a social network tie given precise location information from laptops and cell phones. They used a collection of features of when users are co-located.  Together, these efforts have begun to lay a foundation for the study geo-social media.









\section{Location Estimation: Problem Statement}
In this section, we build a model for the probability that a user, who we refer to as the target user, lives at a specific location given the approximate location of his contacts. Given a user, our goal is to estimate the location $l$ of the user provided only with some imperfect information about the location of that user's social network.  We first describe the baseline Backstrom model for location estimation, describe the BLAH BALH, then BLAH BLAHB ALHBAL.

\subsection{Baseline: The Backstrom Model}
The Facebook model developed by Backstrom et al. \cite{backstrom2010find} begins with a striking observation: that the probability of friendship is roughly inversely proportional to distance. Specifically, by examining the ratio of actual edges at a particular distance to the total number of possible edges at that distance (i.e., the probability of friendship), they find a curve of the form $a(b+x)^{-c}$, with an exponent close to $c=-1$. With the empirically observed probability of friendship, they divide the set of users into two groups: $L^c$ is the set of locations of a user's contacts; and $L^s$ is the set of all strangers' locations. Then, the Facebook model estimates the likelihood of location $l$ as: 

\[
    \Backstrom(l,L^c) = 
        \prod_{l^c \in L^c} {\p(|l-l^c|) \over 1-\p(l-l^c) }
        \prod_{l^s \in L^s} 1-\p(|l-l^s|)
\]

\noindent where $\p$ is the probability of friendship given an input distance (which again, can be derived empirically). [ADD SENTENCES GIVING INTUITION OF HOW THE BACKSTROM MODEL REALLY WORKS] The last product in the likelihood formula is only a function of the location $l^c_i$ and the locations of the strangers; it does not depend on any other information about the target user's contacts. For convenience, we refer to this as $\pStrangers$:
\[
    \pStrangers(l) = \prod_{l^s \in L^s}1-p(|l-l^s|)
\]

\noindent As suggested in \cite{backstrom2010find}, this can be pre-computed for every location. [ADD ONE SENTENCE SUMMARIZING WHAT THEY FIND] 


The Backstrom model naturally aggregates the locations of a user's contacts, such that nearby friends BLAH BLAHBLAH. However, directly applying this approach to other non-Facebook domains may encounter difficulties. First, the Facebook empirical study focused only on the continental US, meaning that distances between contacts were naturally limited to around 1,000 miles. When investigating global friendships (as on Twitter or on the rest of Facebook), there is considerable noise introduced in the 1,000--10,000 mile range due to the distribution of land and oceans on the surface of the earth. Second, the Facebook dataset had street addresses for approximately 2.9 million Americans, and they used the friendships between users with street addresses to do the calculation. In practice, however, many users in social media reveal broad, imprecise locations (e.g., at the city or state level), while others provide fine-grained latitude-longitude information. Third, the strength of connection between users necessarily varies, so capturing this variation is important. Encouragingly, Gilbert \cite{gilbert2009predicting} have shown how the strength of a tie can be predicted by interaction patterns.  Finally, many social systems serve different purposes. Twitter, for example, is both a social network connecting friends (which may tend to be local) as well as a news media (supporting global dissemination)  \cite{kwak2010why}.



\subsection{FriendlyLocation: Incorporating Tie Strength}
A common theme of these challenges is that the quality of the geographic information conveyed by a relationship in social media varies. Some edges may convey strong evidence of the location of a user. For example, intuitively the many edges between a user with an unknown location and his co-workers (for whom we know their location) should contribute strongly to the likelihood that the user is nearby those co-workers. In contrast, links between a user with an unknown location and with a news service (e.g., CNN) should contribute little discriminating power to estimating the location of the user. 

The challenge here is to separate the best contacts, who are likely to be nearby, from bad contacts who are likely to be far away. Simply encoding our intuitions about who should make a good contact is a starting point, but could miss many non-obvious relationships: for example, there may exist a pair of users who are good friends, communicate with each other, have many friends in common, and yet still live on opposite sides of the globe. 

[NEED TO FIX THE NOTATION IN THIS SECTION; NO MENTION OF TRAINING DATA -- JUST MAPPING EDGES TO QUANTILES]
Hence, we propose to assess the relative quality of each edge from a target user to his contacts based, so that edges conveying strong location information are weighed more than others. Concretely, suppose we have a single edge from a user to one of his contacts. We propose to assign this edge to a quantile based on its estimated ``goodness'' (where this goodness can be based on observations over BLAH BLAH BLAH). Suppose we construct a set of $m$ quantiles, representing edges at different distances. Let the boundaries for these quantiles be  $\{q_0,\dots,q_m\}$, where:\footnote{The notation used for order statistic may need some explanation.  $X_{(n)}$ is the $n^{th}$ element in the set $X$ when sorted in increasing order, so $X_{(2)}$ means the second smallest element in $X$.}

\[
    q_j =
    \begin{cases}
        D^p_{(1+\lfloor j|R|/m \rfloor)}, & j=<m \\
        \infty & j=m
    \end{cases}
\]

\noindent The quantile for a specific distance $d^p_i$ can be found by comparing it to the boundaries:
\[
    \quantile(d^p_i) = \max_{j \in \{0,\dots,m\}} \{j: d^p<q_j\}
\]

Hence, we can identify the actual edges ($\actEdges$) that exist with a distance of $d$This lets us find $\actEdges$, which is the number of users who fit in a quantile $j$ and had an actual distance of $d$
\[
    \actEdges(j,d) = |\{
            (d^a_i,d^p_i) \in R :
            d=d^a_i \wedge j=\quantile(d^p_i)
        \}|
\]

By comparing the number of edges that could have existed to the number of edges that actually exist at a specific distance and in a specific quantile, we can find the probability that a contact at a specific distance is in a quantile:

\[
p^*(j,d) = \frac{\actEdges(j,d)}{\edges(d)}
\]

This could be looked at as a classification problem where we want to classify edges as local or non-local, but the problem is there is a smooth continuum from local to non-local, and semi-local friends can be useful for location prediction. As a result, we model this as a regression problem. 





We propose improving their system by adding in information from the decision tree. We do this by replacing the probability of being a contact based purely on distance ($p$) to the probability we found in the previous section ($\pContact$). We now have a formula for predicting the best location given $L$, the set of locations of the contacts, and $P$, the set of predicted distances to the same
contacts:
\[
    FL(l,L,P) =
        \left(
            \prod_{l^c_k \in L,p_k \in P}
            {p^*(\quantile(p_k),|l-l^c_k|) \over (1-p(|l-l^c_k|))}
        \right)
        \pStrangers(l)
\]

Location prediction with a maximum likelihood estimator requires an estimate of the probability that a user lives at a specific location. We can find that probability by comparing the distribution of Twitter users to the distribution of the contacts. First, we needed a model for the density of Twitter users. We calculate the distance between every target user and every contact (even for contacts and users who had no relationship). We call the number of target and contact pairs that are $d$ miles apart $\edges(d)$.

% i index in R, decision tree tuples
% j index in Q, quantile boundaries
% k index in 

Next, we need to model the probability that two users are contacts. We ran the decision tree regressor on the training data to create a set of
tuples $R = (d^a_i, d^p_i)$ for $d^a_i \in D^a$ and $d^p_i \in D^p$ where $d^a_i$ is the actual length of the edge, and $d^p_i$ is the value predicted by the decision tree. 






For each of the quantiles, we can fit $p^*$ to the curve from \cite{backstrom2010find}:
\[
    p^*(j,d) = a_{j} (b_{j}+d)^{-c_{j}}
\]

\begin{figure}[]
\centering
\includegraphics[width=\linewidth]{figures/near_prob_fit.pdf}
\caption{
[I THINK PROBABILITY IS MISSPELLED IN THE FIGURE Y AXIS. After splitting edges into groups based on their predicted distance, each group
was fit to a curve. Here are four of the ten curves and their curves of best
fit. The other six curves of best fit are shown as faint dotted lines.}
\label{fig:NearProbFit}
\end{figure}

We choose to split into ten quantiles, which gave us ten different curves for the probability that a certain type of contact exists between a pair of users.  Four of the ten curves from one of the folds from the five-fold evaluation and their lines of best fit are shown in Figure~\ref{fig:NearProbFit}. The best contacts are orders of magnitude more likely to live near a target user than the worst contacts. If the predictions from the tree regressor were ignored, and users were placed into one group instead of ten equal groups, this would reduce to the model for friendship and distance presented in \cite{backstrom2010find}. We choose ten because it was large enough to distinguish between the curves.  Larger numbers of quantiles give no benefit since the curves we are fitting are so noisy as can be seen in Figure~\ref{fig:NearProbFit}.




%Algorithm~\ref{alg:friendloc} shows all the pieces from this section and the previous section tied together.






\section{Factors Impacting BLAH BLAH}
In the previous section, we formalized the location estimation problem incorporating evidence of tie strength. But what factors actually impact the distance BLAH BALHB LABHA? In this section, we empirically examine a large sample from Twitter, totaling 100 million geo-encoded tweets and 73 million user profiles. Based on this sample, we examine the following properties to study how various types of edges correlated with proximity, including (i) friendship relationships, (ii) conversations between user, (iii) friend and follower counts, (iv) granularity of locations, BLAH BLAH.


%All of the analysis in this section was done on the contacts of the 249,584 target users.
% Contacts with a predicted location error that was greater than or equal to 1000 miles were filtered out.


\subsection{Data Collection from Twitter [TIGHTEN THIS SECTION 1/2 of a column]}
To investigate how social relation and geographical distance between the
relations correlate, we sample a dataset from Twitter.
%
Our analysis and prediction is based on data collected from Twitter during
May, June, and July of 2012.

We built a crawler to find these contacts for users who used Twitter's Location
Feature to disclose their location.
%
The crawler sampled over one hundred million geo-coded tweets by monitoring
Twitter's public streaming API for all of May 2012.
% 118,464,320 lines including keepalive newlines and non-status messages.
We kept the tweets from the users who posted at least three tweets, which left
us with 1,758,101 Twitter users.
%
For each of these users with geo-coded tweets, we used the median latitude and
median longitude of the locations of the user's tweets as an approximation of
her home location.
%
Some Twitter accounts, such as accounts that posted jobs, would
move around faster than a human could possibly move.
%
To account for this, the crawler calculated the distance between each tweet and
the user's home location.
%
The crawler ignored users if the median distance from their tweets to their
home location was greater than 50 miles.
%
This only removed 3.4\% of the geo-located users.
%
We also removed an additional 2.9\% of the geo-located users who did not have
any contacts with locations we could decode, which left us with 1.6 million
Twitter users with a known location.
%
We randomly selected 249,584 of these users for analysis and experimentation.
\ifdefined\THESIS
\footnote{We originally selected 250,000 users, but had to remove 416 of them.
These users had contacts with locations, but none of their contacts had
meaningful locations.}
\fi
%
Almost all of the experiments in this paper are based on these target
users.

[ADD A SUMMARY TABLE OF THE DATA WE HAVE]


%To enable parallelization, we divided those users into 100 groups based on
%the two least significant digits in their Twitter user id, and randomly selected
%2500 users from each of the groups.

% distribution of the contacts
%     med  avg      std
%rfrd 62.0 132.7148 278.394
%jfol 35.0 143.4844 456.629
%jfrd 78.0 153.5700 241.222
%jats  5.0   7.0764   8.060

For all of the target users, the crawler used Twitter's API to download
the users' 100 most recent tweets, a list of friend ids, and a list of follower ids.
%
Most of the target users had plenty of contacts of each of the four types.
%
The median number of reciprocal friends is 62, and the average is 132.
%
The average numbers are higher because the number of contacts a user has
follows a heavy-tailed distribution.
%
The medians for other types of contacts are 35 just followers, 78 just friends,
and 7 just mentioned.
%
If a user had over 25 contacts in any of the four types of contacts, the
crawler chose a random sample of 25 from each of the types of contacts, and
downloaded the profiles for up to 100 total contacts per target user.
%
From that 100, we randomly picked at most 25 contacts with locations we could
decode to be the located contacts. For those located contacts, we downloaded
their friends, followers, and tweets.
%
We finished this process by downloading up to 100 profiles of the contacts of
the contacts.
%
Since the Twitter social network graph has a large strongly connected
component, there are a significant number of users who are contacts or leafs for
more than one target user.
%
In the end, we collected just over 73 million Twitter user profiles.



\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/edge_types_cuml.pdf}
\caption{
CDF of distance from target users to users they have some contact
with.
%
Reciprocal friends tend to be closer than other types of friendships.
}
\label{fig:EdgeTypesCuml}
\end{figure}





\subsection{Factor 1: What type of contact is closest?}
\label{sec:EdgeTypes}

Figure~\ref{fig:EdgeTypesCuml} shows the cumulative distribution
function (CDF) of the distance between a target user and several types of
contacts.

Any given contact can be categorized into precisely one of these four disjoint
sets:
\begin{description}
\item[reciprocal friend] The target user follows this user and is followed
    back.
\item[just friend] The target user follows this user and is not followed
    back.
\item[just follower] The target user is followed by this user, but does
    not follow them.
\item[just mentioned] The users do not follow each other, but the target
    user mentioned the name of the other user in a tweet.
\end{description}



%
Distance is plotted on a logarithmic scale to show both local and
global effects.
%
On a logarithmic scale, the contacts are fairly evenly distributed from being
nearby to being on the opposite side of the world.
%
For reciprocal friends, the 1\textsuperscript{st} quartile, median, and
3\textsuperscript{rd} of the distances are 7.9 miles, 106 miles, and 720 miles
respectively.
%
There is a relatively flat section in all the lines around 3,000 miles.
%
3,000 miles is longer than the distance between the east coast of the U.S. and
the west coast, but shorter than the distance from the east coast of the U.S.
to Europe, so there are few population centers that are this distance apart.

In general, reciprocal friends are the closest, followed by followers, friends,
and finally users who are just mentioned.
%
38\% of reciprocal friends live within 25 miles while only 18\% of users
who are just mentioned live within that radius.
%
While it may seem that since being followed by someone and following someone
should be identical, they are not.
%
Celebrity and news accounts on Twitter often have large numbers of followers,
but they normally do not follow a large number of users.
%
Since the target user is selected randomly, they are usually an average
user and not a celebrity.
%
If they follow someone, it might be a celebrity; however, if someone follows
them, it is probably someone who knows them.

\begin{figure}[tbh]
\centering
\includegraphics[width=.9\linewidth]{figures/edge_types_norm.pdf}
\caption{
Histogram of distance to users for different types of relationships.
The curves in this figure are the derivatives of the curves in
Figure~\ref{fig:EdgeTypesCuml}.
}
\label{fig:EdgeTypes}
\end{figure}

\subsection{What is the distribution of contacts?}

To understand the distribution of contacts, we create a logarithmically-scaled
histogram of the distances between various types of contacts.
%We sort the distances to contacts into 160 logarithmically
%scaled bins (40 bins for each power of 10).
%
Figure~\ref{fig:EdgeTypes} shows the result of plotting the histogram.
%
All four types of contacts follow roughly the same
distribution: one peak around 10 miles from people who live nearby, and several
other peaks between 100 and 10,000 miles.
%
Since the contacts often list the name of their town, there is a small distance
between the geocoded location of the town and the location of the target
user's tweets.
%
There aren't as many contacts in the 30 to 150 mile range, but then after 150
miles, peaks start appearing for major cities.
%
One reasonable explanation for this is that Twitter is not just a social
network; it is also a news distribution network as described in
\cite{kwak2010why}.
%
This distribution suggests that users have two types of contacts: people who
they met in real life, and people who they met online or know about via
mainstream media.
%
The former group is useful for predicting location and the latter group is not.
%
%In section~\ref{sec:model}, we use this idea that there are two types of contacts to build a predictive location model based on social ties.


\begin{figure*}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/edge_counts.pdf}
\caption{
A comparison between number of followers and proximity---people who have more
friends or followers tend to be further away.
}
\label{fig:EdgeCounts}
\end{figure*}

\subsection{Does the number of friends and followers a person have affect how
close they are?}

Since the primary goal of this research is to predict the location of users, we
want to be able to discern the differences between contacts.
%
When looking at number of friends and followers, we focus our attention on the
number of friends and followers a contact has rather than the numbers for the
target user.
%
We took each of the reciprocal friendships that we looked at in
Section~\ref{sec:EdgeTypes} and put them into five log-scaled bins based on
the number of friends or followers that the contact had.
%
Figure~\ref{fig:EdgeCounts} shows the result of this procedure.

In general, people who are more promiscuous followers and friends are less
likely to live nearby.
%
This makes sense because it is easy to meet 15 Twitter users in real life, but
very few people know 1000 Twitter users who live in the same town.
%
Contacts with 10--99 followers were within 25 miles of their geo-located friend
45\% of the time while contacts with 1000--9999 followers were nearby only 26\%
of the time.
%
There was a similar result in the number of friends: the proportion of local
contacts went from 46\% down to 23\%.

Mainstream media and celebrity accounts such as the New York Times and Lady
Gaga have millions of followers while normal users rarely have more than a few
hundred.
%
Follower count and friend count are good ways to distinguish celebrity and news
accounts which are useless for location prediction.

\ifdefined\THESIS
    \begin{figure}[tbh]
    \centering
    \includegraphics[width=\linewidth]{figures/com_types.pdf}
    \caption{
    CDF of the distance between a target user and various types of contacts
    plotted on a logarithmic scale.
    }
    \label{fig:ComTypes}
    \end{figure}
\fi


\begin{table*}[tbh]
\scriptsize
\centering
\begin{tabular}{l | r r | r r | r r | r r | r r}
    & \multicolumn{2}{c}{both mention}
    & \multicolumn{2}{|c}{target mentions}
    & \multicolumn{2}{|c}{contact mentions}
    & \multicolumn{2}{|c}{both ignore}
    & \multicolumn{2}{|c}{overall} \\
    \cline{2-11}
    &local&count&local&count&local&count&local&count&local&count \\
    \hline
    recip friend & 42\%&28067 & 50\%&17903 & 45\%&21066 & 35\%&168973 & 38\%&236009 \\
    just follower & 40\%&2001 & 47\%&792 & 40\%&5958 & 25\%&216834 & 25\%&225585 \\
    just friend & 21\%&23314 & 40\%&910 & 42\%&1884 & 21\%&212969 & 21\%&239007 \\
    just mentioned & 18\%&182978 & 36\%&4721 & & 0 & & 0 & 18\%&187699 \\
\end{tabular}
\caption{
If target users interact with their contacts, then they are more likely to
live nearby.
%
In this table, ``I'' refers to the target user. ``You'' refers to their
contact.
%
}
\label{tab:ComTypes}
\end{table*}

\subsection{Are users closer to people they communicate with?}

We look at the 100 most recent tweets for the targets and one of their
contacts for each type of their contacts.
%
The edges are divided into groups based on whether the target user
mentioned the contact and whether the contact mentioned the target user.
%
For each of the groups, we calculate the percentage of contacts who
live within 25 miles of the targets and the number of edges in that group.
%
This is shown in Table~\ref{tab:ComTypes}.
%
Since contacts who were just mentioned were mentioned by the target
user by definition, the contact mentions and both ignore table cells are
empty.

In almost every case, increased communication increases the probability that
two users live near each other.
%
There is one exception: when an average user mentions someone they follow who
does not follow them back, it has no effect---in both cases the contact is
local 25\% of the time.
%
In other words, if a random user mentions a celebrity who does not bother to
reply, they probably do not live in the same area.
%
On the other hand, in the rare event that someone who is just a friend replies
to their follower, then the probability that they live near each other is much
higher---it goes from 21\% to 42\%.

The weakest type of contact is users who were just mentioned, but never
replied to.
%
If the person is mentioned, then 36\% of users with no
friend/follow relationship who have a conversation live within 25 miles.
%
This is approximately equal to the 35\% of reciprocal friends who ignore each
other and live within 25 miles.
%
Unsurprisingly, the strongest type of connection is reciprocal friends who
communicate.
%
One challenge to using communication patterns as a source of information for
location prediction is that the communication patterns that are correlated
with proximity are rare.

\begin{table}[tbh]
\centering
\begin{tabular}{l | r r | r r}
    & \multicolumn{2}{c}{Public}
    & \multicolumn{2}{|c}{Private} \\
    \cline{2-5}
    &local&count&local&count \\
    \hline
    Recip Friend & 37\%&211136 & 41\%&24873 \\
    Just Follower & 25\%&204417 & 31\%&21168 \\
    Just Friend & 21\%&233849 & 39\%&5228 \\
    Just Mentioned & 18\%&183368 & 35\%&4331 \\
\end{tabular}
\caption{
    Comparison between public accounts and private accounts on Twitter.
    Private accounts tend to be closer.
}
\label{tab:EdgeTypesProt}
\end{table}

\subsection{Are users closer to private accounts?}

Like many social networks, Twitter allows users to control the privacy settings
on their account.
%
The specifics differ from network to network, but in Twitter's case
a user can make their account private which means followers have to get
permission to follow the account.
%
There are demographic differences between public and protected accounts.
%
For example, Gilbert \cite{gilbert2008network} demonstrates that rural users
are more likely to make their accounts private than public accounts.
%
In the case of protected accounts on Twitter, basic information
about their profile such as their location and the number of friends and
followers is public, but their friends list, followers list, and the text of
their tweets is private, and not available for analysis.

As seen in Table~\ref{tab:EdgeTypesProt}, the most dramatic difference between
private and public occurs if a user follows a protected account.
%
Since users generally only allow people they know to follow a protected
account, this brings the users almost as close together as if they were
reciprocal friends.
%
On the other hand, if a protected account follows the target user, they
are only slightly more likely to be nearby.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/near_triads.pdf}
\caption{
Comparison between distance to a mutual friend, labeled ``our'', and someone
who is not a mutual friend, labeled ``my''.
If two contacts are mutual friends and live near each other, a target user is
more likely to live near them than two contacts who live nearby but are not
mutual friends.
}
\label{fig:NearTriads}
\end{figure}

\subsection{If two of your friends live near each other, does that increase the
chance that they live near you?}

In this section, we turn our attention to triangles of users.
Finding useful relationships between the edges of a social triangle is tricky
because the three distances depend on each other.
Unfortunately, it is fairly simple to show using the triangle inequality theorem
that if two users are 1000 miles apart, then the third member of the triangle
has to be at least 500 miles from one of the other two.
Since this isn't a useful result, we designed a more complex experiment to
analyze the relationship between the sides of the triangle.
A script searched for a specific pattern in the social network of
the target user's reciprocal friends: two people who were friends with each
other and a third person who had no connection with the other two:

\begin{center}
\includegraphics[width=0.3\linewidth]{figures/near_triads_dia.pdf}
\end{center}

To help label the four users, we describe this social graph from the
perspective of the target user:

\begin{itemize}
\item ``me'' is the target user
\item ``you'' is the contact who is reciprocal friends with ``me''
\item ``my'' has no relationship with ``you'' and is reciprocal friends with ``me''
\item ``our'' is reciprocal friends with both ``me'' and ``you''
\end{itemize}

We found this pattern for 147,669 of the target users.
%
If a user had multiple instances of this pattern, it picked one of them
randomly so that particular users would not bias the results.
%
%Since our crawler only retrieved friend and follower information for a few
%reciprocal friends per user, it is reasonable to assume that this pattern
%is more common, but the sample is more than enough data to draw some
%conclusions.
%
Figure~\ref{fig:NearTriads} shows a comparison between distances to the ``my''
users and the ``our'' users.
%
For each of the ``my'' users and the ``our'' users, we put them into one of
four logarithmically scaled bins based on their distance from the ``you'' user.
%
Then we plot the CDF for the distance from the target to the ``my'' and ``our'' users.
%
This allows us to investigate the effect of mutual friendship on distance.
We report one very simple result: if two of your friends are close (within 10
miles), then whether they know each other or not strongly affects how close
you are to them.
%
If they are farther apart, it doesn't matter.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/locals_10.pdf}
\caption{
The colored lines show the distance to contacts split into groups based on the
proportion of the contact's friends and followers who live near the contact.
The dotted line shows the distance to contacts who have no locatable contacts.
This graph is based on at most 10 leafs per contact.
Contacts who have a high proportion of nearby leafs are much more likely to
live near the target user.
}
\label{fig:Local10}
\end{figure}

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/locals_cmp.pdf}
\caption{
    Distances to contacts with a local contact ratio better than the median LCR
    for several numbers of leafs.
    Although looking at more leafs makes users with a high LCR more likely to
    be nearby, it probably doesn't justify how long it takes to compute.
}
\label{fig:LocalCmp}
\end{figure}

\subsection{Are some users closer to all of their friends and followers?}
\label{sec:closer}

In the previous sections we only looked at the contacts of the target
users.
%
In this section we will go two steps out on the social graph and
investigate the friends-of-friends.
%
We want to know if some users are more localized than others, so we compare
contacts with lots of local contacts to contacts with mostly distant contacts.
%
\textbf{Local Contact Ratio}(LCR) is the fraction of a user's contacts
who live near the user.
%
For a contact at location $l^c$ and a set of their contacts' locations L, we
formally define LCR as follows:
\[
    LCR(l^c,L) = { |\{ l_i \in L : |l_i-l^c|<25 \}|
                    \over |L| }
\]
%
We picked a cutoff distance of 25 miles to distinguish between local and non-local
contacts.
25 miles is about the distance where the bulk of local users ends as seen in
Figure~\ref{fig:EdgeCounts}.
%
The distance cutoff is somewhat arbitrary, but it doesn't seem to matter much
in practice since we are really trying to distinguish between contacts who are
hundreds of miles away and contacts who live in the same town.
%
Around one in ten contacts did not have any contacts with a location from the
contacts we looked at--they were treated as a separate group.

In \cite{li2012towards}, the authors model the probability distribution of
user's followers using a Gaussian distribution, and use this to build a
location prediction system.
%
There are many other ways to analyze the leafs: average distance to the leafs,
median distance to the leafs, fitting the distances to a curve such as a
Gaussian.
%
We are looking at location prediction anywhere in the world, which means
contacts may be 10,000 miles away, and a location 10,000 miles away is nearly
as bad as a location 1000 miles away, so average is obviously not useful.
%
The disadvantage to using the median is more subtle.
%
As seen in Figure~\ref{fig:EdgeTypesCuml}, the median distance to a contact is
often in the 100--1000 mile range, and only about a third of contacts are
actually local.
%
This means that median distance to leafs does a reasonable job of separating the
worst contacts from the average contacts, but local contact ratio does a better
job of identifying the very best contacts.

The figure shows that some users are much more local than other users.
For example, a local newspaper may have thousands of followers and few friends,
but the people who follow a newspaper are generally local.
According to the other factors we looked at, the newspaper is a bad predictor
of location, but in reality it is a great predictor.

Of the factors we have investigated, this is the one that is most strongly
correlated with distance---in the next section we will see that local contact
ratio ends up at the top of a decision tree to separate local contacts from
non-local contacts.
%
One problem with this technique is that it is somewhat expensive to deal with
the large number of profiles two steps out on the social graph.
%
Our crawler originally looked at 100 leafs per contact because Twitter's API
will return up to 100 profiles at a time, but fetching and saving all those
profiles is slow.
%
In Figure~\ref{fig:LocalCmp}, we compare contacts with a high LCR calculated
using at most 100 leafs per contact to at most 10 leafs per contact.
%
The percentage of contacts within 25 miles with a good LCR based on 10 leafs,
20 leafs, and 100 leafs was 53\%, 55\%, and 58\%, respectively.
%
All of these are noticeably closer than reciprocal friends who are within 25
miles 38\% of the time.


\subsection{Summary}
Based on this large-scale analysis of Twitter, we observe the following: 

\begin{itemize}
\item Reciprocal friendships tend to be physically closer than contacts with less strong relationships such as someone who is just a follower.
\item Contacts who talk to the target user on Twitter tend to be located nearby.
\item if the contact mentioned the target---this is also true in the other direction.
\item Protected accounts tend to be closer, but we provide less additional information for assessing their relative quality.
\item Contacts with lots of friends and followers tend to be further away (since, in many cases these contacts correspond to celebrities or news organizations).
\item Contacts with more precise locations are more useful for location prediction.
\item Some people have lots of friends who are close by, and other people have friends who are far apart.
\end{itemize}



\section{Building and Evaluating the Location Estimator}

Since most of the input features are correlated and either binary or non-linear,
linear regression is unlikely to work well. In addition, the data is dense and low-dimensional, so Support Vector Machines
do not work well.  We chose to use a decision tree regressor based on the CART algorithm (classification and regression trees) to distinguish the best edges from the worst. A decision tree regressor works similar to the well-known decision tree classifier, except that it produces real numbers as output instead of discrete classes. During training, the training data is recursively split based on the input
variable with the most predictive power to build a binary tree.  Each of the internal nodes of this tree have a cutoff for one of the input
variables, and the leaves of the tree have a predicted value.

Since the distances between users varied by several orders of magnitude, we
trained the regressor to predict the log of the distance.
%
The tree regressor was configured to not split leafs with fewer than 1000 data
points to prevent over-fitting.
%
The top three levels of a decision tree are shown in Figure~\ref{fig:TreeTop}.
%
The predictor does not do a great job of predicting the actual distance to a
contact; there's simply too much noise.
%
However, it does do an excellent job of separating the closest pairs of users
from the most distant pairs as we will show in the next section.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/tree_top.pdf}
\caption{
    The top three levels of the decision tree. This decision tree will predict a
    distance of 839 miles for a contact with a local contact ratio of .2 and
    2800 friends. It will predict a much-closer distance of 43.7 miles for a
    user with a local contact ratio of .5 and a predicted location error of 10
    miles.
}
\label{fig:TreeTop}
\end{figure}



We evaluate the system against a baseline implementation, and we investigate
several modifications to the system.
%
We use five-fold cross validation on the target users to evaluate the system.
We evaluated the FriendlyLocation system against the 249,584 target users.

For each of the folds, we ran the tree classifier and generated a new set of
curves for $\pContact$ from the training data.
%
We did not recalculate $\pStrangers$ or the probability as a function of distance
used for the baseline, since these are fairly independent of the selected set
of users.

We evaluate the system against the metrics used in previous works:
accuracy at 25 miles (ACC) which was used in \cite{backstrom2010find}
and average error distance (AED) proposed in \cite{cheng2010you} and
extended in \cite{li2012towards}.
%
Following the notational conventions from \cite{li2012towards}, we define ACC
and AED for a set of users $u \in U$ with $\Err(u)$ as the distance between a
target user's home location and the predicted location.

Accuracy is the fraction of users who live within 25 miles of their predicted
location:
\[
    \ACC(U) = { |\{ u \in U : \Err(u)\le25 \}| \over |U| }
\]

Average error distance (reported as AED@100\%) is as follows:
\[
    \AED(U) = { \sum_{u \in U} \Err(u) \over |U| }
\]

We also use the extension of AED created by \cite{li2012towards}:
\begin{quote}
However, as AED is easily affected by outliers in results, we report AED at
different percentiles (60\%, 80\% and 100\%) of users ranked by their error
distances. E.g., AED@60\% is the average error distance of the top 60\% of
users ranked by their error distances.
\end{quote}
The effect of outliers that they mention is even larger in our work than theirs
because we are using locations from around the world instead of focusing on
just the U.S.

We investigate several implementations of the FriendlyLocation system along
with two baseline systems, which we will discuss in upcoming sections:
\begin{description}
\item[Baseline] This is based on the MLE estimator presented in
    \cite{backstrom2010find}. Some changes to the system had to be made to make it
    work on Twitter's directed graph. (Facebook friendships are always
    reciprocal.)
\item[Nearest Contact] This predictor chooses the location of the contact that
    the tree regressor picks as the closest contact.
\item[FriendlyLocation Basic] This is the system described in the previous
    section with only information from the locations of contacts.
\item[FriendlyLocation - Strangers] This is the system described in the previous
    section without $\pStrangers$.
\ifdefined\THESIS
\item[FriendlyLocation + Time Zone] This is the system described in the previous
    section plus the target user's time zone information.
\fi
\item[FriendlyLocation + Location] This is the system described in the previous
    section plus the target user's reported location is included in the
    estimation.
\end{description}

\begin{figure}[tb]
\centering
\includegraphics[width=\linewidth]{figures/fl_basic.pdf}
\caption{
    FriendlyLocation against several baseline systems.
}
\label{fig:results}
\end{figure}

\begin{table*}[tb]
\centering
\begin{tabular}{l  r r r r}
    Model & aed@60 & aed@80 & aed@100 & acc@25 \\
    \hline
    Baseline & 8.41$\pm$.038 & 40.8$\pm$.20 & 426$\pm$3.9 & 55.7\%$\pm$.09\% \\
    Nearest & 7.73$\pm$.117 & 50.3$\pm$.39 & 594$\pm$9.3 & 56.5\%$\pm$.22\% \\
    FriendLoc$-$Strangers & 5.79$\pm$.028 & 25.2$\pm$.18 & 377$\pm$4.3 & 62.4\%$\pm$.09\% \\
    FriendLoc$-$Leafs & 5.36$\pm$.011 & 22.1$\pm$.12 & 367$\pm$4.0 & 63.6\%$\pm$.12\% \\
    FriendLoc Basic & 5.35$\pm$.008 & 21.4$\pm$.12 & 364$\pm$3.2 & 63.9\%$\pm$.05\% \\
\ifdefined\THESIS
    FriendLoc+Time Zone & 5.33$\pm$.009 & 21.1$\pm$.07 & 352$\pm$3.5 & 64.0\%$\pm$.04\% \\
\fi
    FriendLoc+Location & 4.54$\pm$.011 & 15.7$\pm$.27 & 325$\pm$2.6 & 66.9\%$\pm$.16\% \\
    FriendLoc+Cutoff & 4.56$\pm$.026 & 15.1$\pm$.22 & 343$\pm$4.2 & 67.4\%$\pm$.08\% \\
\end{tabular}
\caption{
    Results of our location prediction system when compared to a baseline.
    The value after the $\pm$ is the standard deviation from the five-fold
    cross-validation.
    Including the target user's time zone information does not improve the
    results, but using the target user's reported location, if they gave one,
    makes for significantly better results.
}
\label{tab:results}
\end{table*}

\subsection{Basic FriendlyLocation}

Table~\ref{tab:results} shows our system compared to a baseline implementation.
%
As seen in the table our basic FriendlyLocation system predicts the location
within 25 miles 63.9\% of the time.
%
Our basic system preforms significantly better than the baseline implementations.
%
The results are more impressive when you look at it in terms of average error
distance.
%
The baseline system has an average error distance of 40.8 for the best 80\% of
predictions, and our basic system has an average error distance of 21.4.
%
This means that our system is better at making good estimates better than it is
at making bad estimates good.
%
Unfortunately, when the predictor is wrong, it can be very wrong.
%
As seen in Figure~\ref{fig:results}, around a tenth of the predictions are worse
than 1000 miles for all of the predictors.
%
Some of this inaccuracy may be caused by inaccurate training data, but there is
no real way to know.



\ifdefined\THESIS
\subsection{Time Zone}
When the predictor is wrong, it is often wrong by thousands of miles.
%
All users on Twitter have a time zone setting for their account which is used
to display the times that tweets were posted.
%
The time zone is set automatically when a user registers, and the user can
change it, but it is still not always correct.
%
The time zone information is made available on the Twitter API as the offset
in seconds from UTC.
%
We compared the longitudes of the target users to the UTC offset for their
profiles.
%
We put the target users into one of 24 groups based on x, the target user's
longitude and z, the UTC offset measured in hours:
${(\lfloor {x\over15}\rfloor-z+24)\mod{24}}$.
%
We found that 72\% of Twitter users fit into either group 0 or 1.
%
We define $\pTimeZone$ to be the fraction of the target users who fit into one
of the 24 groups.
%
We modified the formula for $\FriendLoc$ to include $\pTimeZone$ as follows and
re-ran the evaluation.
\[
    \pTimeZone(l,z)
    \left(
        \prod_{l^c_k \in L,p_k \in P}
        {\pContact(\quantile(p_k),|l-l^c_k|) \over (1-p(|l-l^c_k|))}
    \right)
    \pStrangers(l)
\]
The evaluation results for this formula are in the ``FriendLoc+Time Zone'' row
of Table~\ref{tab:results}.
%
We hoped that the time zone would help us avoid locations on the wrong side of
the world; unfortunately, adding the time zone information does not improve the
location prediction.
%
Part of the problem is that the time zone settings are often wrong---over 9\% of
the target users have a time zone setting in the hemisphere opposite their home
location.
%
The actual time zones on the earth have lines that are much more complex than
the simple metric we used, but they rarely differ by more than an hour one way
or the other.
%
Since this showed so little benefit, it is unlikely to be improved by better
time zone lines.

\fi

\subsection{Location Field}
Many Twitter users fill out the text-based location field.
%
If this user-reported data is good, there is no reason to spend time
crawling their contacts.
%
It would be nice to use this information when predicting location, but
the target users we used to do the evaluation are less concerned about
the privacy of their location information than the average Twitter user.
%
As a result, they tended to give more precise information in the location
field of their user profile than other users.
%
We assume that the locations supplied by the contacts are more
representative of normal Twitter users so we added noise to the locations
of the target users to make the distribution of the quality of their
locations would match the quality of the contacts.
%
First, we sorted all the target users and all the contacts by their
PLE(predicted location error).
%
Next, we looked at each percentile of the target users and compared
their PLE to the PLE for that percentile in the contacts.
%
For each of the target users, we moved the user's location based on
reverse geocoding away from the user's actual median location based on the
difference between the PLEs.
%
For example, the median PLE for a target user was 5.9 miles, and the median
PLE for a contact was 6.7 miles.
%
This means that we need to add .8 miles of noise to a target user
with a PLE of 5.9 so that the quality of the geo-located target user's location
would match the quality of normal Twitter users.
%
We also removed the location field from 17\% of the target users to
make the proportion of target users with a location match the general
Twitter population.

After doing this, we can use the user-supplied location of the user we are
going to predict.
%
We investigate two different ways of using this information.
%
The simpler of the two, which we refer to as ``FriendLoc+Cutoff'' in
Table~\ref{tab:results}.
%
If the PLE for the target user's geocoded location is less than or equal to 25
miles, then we use the geocoded location as the actual location; otherwise, we
ignore the geocoded location and just use $\FriendLoc$t diff to find the location.
%
This method locates 67.4\% of users within 25 miles, and is the best method
that we found.

We also look at including the geocoded location in the maximum-likelihood
estimation similar to what we did for time zones.
%
The same data that was used to generate Figure~\ref{fig:DiffMlocMdist} can be
used to calculate the probability that a user lives a certain distance from
their geocoded location.
%
We take the location error, which is the distance between a user's home
location and geocoded location, for all the target users with a location the
geocoder can decode, and find the distribution of these errors.
%
This lets us add $\pLocation$ into the maximum-likelihood estimator:
\[
    \pLocation(|l-l^g|)
    \left(
        \prod_{l^c_k \in L,p_k \in P}
        {\pContact(\quantile(p_k),|l-l^c_k|) \over (1-p(|l-l^c_k|))}
    \right)
    \pStrangers(l)
\]
\\{Do we want ``FriendLoc+Location''? It helped, but it is not as good as the
    cutoff and more complicated.}


\subsection{Ignoring Strangers}
Calculating $\pStrangers$ is very expensive.
%
It only has to be computed once, but if you wanted to do location prediction on
a different social network, it would need to be recomputed.
%
We investigate the FriendlyLocation system without this information, by running
prediction without multiplying by $\pStrangers$ when calculating the overall
probability for each location:
\[
    \prod_{l^c_k \in L,p_k \in P} \pContact(\quantile(p_k),|l-l^c_k|)
\]
As seen in Table~\ref{tab:results}, removing this information results in a
slightly worse prediction.
%
There is a trade-off to be made here, and it may not be worth the time it takes
to calculate $\pStrangers$.

\subsection{Prediction Using Only Contacts}
Local Contact Ratio was the top node in the tree classifier for all 5 decision
trees, which means it was the most important feature for classification.
%
However, getting information about the leafs is by far the most expensive part
of the crawling and predicting process.
%
If we don't crawl the leafs, we also do not need to download the friends and
followers of the contacts to find the leafs, which makes the process well over
an order of magnitude faster.
%
We re-ran the tree regreessor, curve fitting, and prediction using only
information from the target users friends, followers, and tweets and the
profiles of the contacts.
%
The accuracy for FriendLoc$-$Leafs at 25 miles was 63.6\% which is not quite as
good as the basic version of FriendLoc at 63.9\% accuracy, but they are still
very close.
%
Prediction using only contacts takes only four calls to Twitter's API instead
of the approximately 80 API calls it took to do the basic version of
FriendlyLocation.

\section{Conclusion}
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vestibulum fringilla orci, vitae dictum enim lobortis mattis. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Proin pellentesque tincidunt velit gravida lacinia. Pellentesque vitae purus nibh, molestie facilisis mi. Donec porttitor dapibus felis, non rhoncus odio laoreet a. Phasellus felis neque, fermentum a sodales vitae, dictum ac dolor. Cras mattis, augue et vulputate aliquet, sapien eros fermentum ligula, sed bibendum dui libero sit amet justo. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vestibulum fringilla orci, vitae dictum enim lobortis mattis. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Proin pellentesque tincidunt velit gravida lacinia. Pellentesque vitae purus nibh, molestie facilisis mi. Donec porttitor dapibus felis, non rhoncus odio laoreet a. Phasellus felis neque, fermentum a sodales vitae, dictum ac dolor. Cras mattis, augue et vulputate aliquet, sapien eros fermentum ligula, sed bibendum dui libero sit amet justo.



\end{document}











build on the largest-to-date network-based approach for location estimation

Facebook researchers analyzed
the physical distance between Facebook users' social relations and utilized the
locations of a user's friends' to predict the user's geographical location
\cite{backstrom2010find}.
%
They picked users who entered their street address in the location field of
their profile and used this to predict the location of their friends using
maximum likelihood estimation.
%
However, the information they used is generally not available outside of
Facebook, since people rarely make their street address public.





(i) location information is often \textit{noisy}, reflecting 
(ii) location information often 

(iii) the strength of social ties 

noisy
varying degrees of granularity
different types of social ties


Several researchers in recent years have looked into predicting user locations
in a social network based on the social graph.


\begin{itemize}
\item the type of contact---reciprocal friendships tend to be physically closer than contacts with less strong relationships such as someone who is just a follower.
\item if the target mentioned the contact---Contacts who talk to the target user on Twitter tend to be located nearby.
\item if the contact mentioned the target---this is also true in the other direction.
\item if the contact had a protected account---protected accounts tend to be closer . We also have less information to give to the tree regressor for protected accounts than public accounts.
\item the contact's follower and friend count---contacts with lots of friends and followers tend to be celebrities or news organizations who tend to be further away.
\item the PLE of the contact's location---contacts with more precise locations are more useful for location prediction.
\item the contact's local contact ratio---some people have lots of friends who are close by, and other people have friends who are far apart.\end{itemize}


\begin{itemize}
\item 
\item 
\item 
\end{itemize}









\section{Preliminaries}



\section{Analysis}
\label{sec:analysis}

Every user who has multiple contacts will usually have some contacts who are
much closer than the others.
%
In order to estimate the locations of users, we would like
to find out which users are most likely to live nearby.
%
In this section, we investigate how various types of contacts correlate with
proximity.
%
All of the analysis in this section was done on the contacts of the 249,584
target users.
%
Contacts with a predicted location error that was greater than or equal to 1000
miles were filtered out.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/edge_types_cuml.pdf}
\caption{
CDF of distance from target users to users they have some contact
with.
%
Reciprocal friends tend to be closer than other types of friendships.
}
\label{fig:EdgeTypesCuml}
\end{figure}

\subsection{What type of contact is closest?}
\label{sec:EdgeTypes}

Figure~\ref{fig:EdgeTypesCuml} shows the cumulative distribution
function(CDF) of the distance between a target user and several types of
contacts.
%
Distance is plotted on a logarithmic scale to show both local and
global effects.
%
On a logarithmic scale, the contacts are fairly evenly distributed from being
nearby to being on the opposite side of the world.
%
For reciprocal friends, the 1\textsuperscript{st} quartile, median, and
3\textsuperscript{rd} of the distances are 7.9 miles, 106 miles, and 720 miles
respectively.
%
There is a relatively flat section in all the lines around 3,000 miles.
%
3,000 miles is longer than the distance between the east coast of the U.S. and
the west coast, but shorter than the distance from the east coast of the U.S.
to Europe, so there are few population centers that are this distance apart.

In general, reciprocal friends are the closest, followed by followers, friends,
and finally users who are just mentioned.
%
38\% of reciprocal friends live within 25 miles while only 18\% of users
who are just mentioned live within that radius.
%
While it may seem that since being followed by someone and following someone
should be identical, they are not.
%
Celebrity and news accounts on Twitter often have large numbers of followers,
but they normally do not follow a large number of users.
%
Since the target user is selected randomly, they are usually an average
user and not a celebrity.
%
If they follow someone, it might be a celebrity; however, if someone follows
them, it is probably someone who knows them.

\begin{figure}[tbh]
\centering
\includegraphics[width=.9\linewidth]{figures/edge_types_norm.pdf}
\caption{
Histogram of distance to users for different types of relationships.
The curves in this figure are the derivatives of the curves in
Figure~\ref{fig:EdgeTypesCuml}.
}
\label{fig:EdgeTypes}
\end{figure}

\subsection{What is the distribution of contacts?}

To understand the distribution of contacts, we create a logarithmically-scaled
histogram of the distances between various types of contacts.
%We sort the distances to contacts into 160 logarithmically
%scaled bins (40 bins for each power of 10).
%
Figure~\ref{fig:EdgeTypes} shows the result of plotting the histogram.
%
All four types of contacts follow roughly the same
distribution: one peak around 10 miles from people who live nearby, and several
other peaks between 100 and 10,000 miles.
%
Since the contacts often list the name of their town, there is a small distance
between the geocoded location of the town and the location of the target
user's tweets.
%
There aren't as many contacts in the 30 to 150 mile range, but then after 150
miles, peaks start appearing for major cities.
%
One reasonable explanation for this is that Twitter is not just a social
network; it is also a news distribution network as described in
\cite{kwak2010why}.
%
This distribution suggests that users have two types of contacts: people who
they met in real life, and people who they met online or know about via
mainstream media.
%
The former group is useful for predicting location and the latter group is not.
%
In section~\ref{sec:model}, we use this idea that there are two types of
contacts to build a predictive location model based on social ties.


\begin{figure*}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/edge_counts.pdf}
\caption{
A comparison between number of followers and proximity---people who have more
friends or followers tend to be further away.
}
\label{fig:EdgeCounts}
\end{figure*}

\subsection{Does the number of friends and followers a person have affect how
close they are?}

Since the primary goal of this research is to predict the location of users, we
want to be able to discern the differences between contacts.
%
When looking at number of friends and followers, we focus our attention on the
number of friends and followers a contact has rather than the numbers for the
target user.
%
We took each of the reciprocal friendships that we looked at in
Section~\ref{sec:EdgeTypes} and put them into five log-scaled bins based on
the number of friends or followers that the contact had.
%
Figure~\ref{fig:EdgeCounts} shows the result of this procedure.

In general, people who are more promiscuous followers and friends are less
likely to live nearby.
%
This makes sense because it is easy to meet 15 Twitter users in real life, but
very few people know 1000 Twitter users who live in the same town.
%
Contacts with 10--99 followers were within 25 miles of their geo-located friend
45\% of the time while contacts with 1000--9999 followers were nearby only 26\%
of the time.
%
There was a similar result in the number of friends: the proportion of local
contacts went from 46\% down to 23\%.

Mainstream media and celebrity accounts such as the New York Times and Lady
Gaga have millions of followers while normal users rarely have more than a few
hundred.
%
Follower count and friend count are good ways to distinguish celebrity and news
accounts which are useless for location prediction.

\ifdefined\THESIS
    \begin{figure}[tbh]
    \centering
    \includegraphics[width=\linewidth]{figures/com_types.pdf}
    \caption{
    CDF of the distance between a target user and various types of contacts
    plotted on a logarithmic scale.
    }
    \label{fig:ComTypes}
    \end{figure}
\fi


\begin{table*}[tbh]
\scriptsize
\centering
\begin{tabular}{l | r r | r r | r r | r r | r r}
    & \multicolumn{2}{c}{both mention}
    & \multicolumn{2}{|c}{target mentions}
    & \multicolumn{2}{|c}{contact mentions}
    & \multicolumn{2}{|c}{both ignore}
    & \multicolumn{2}{|c}{overall} \\
    \cline{2-11}
    &local&count&local&count&local&count&local&count&local&count \\
    \hline
    recip friend & 42\%&28067 & 50\%&17903 & 45\%&21066 & 35\%&168973 & 38\%&236009 \\
    just follower & 40\%&2001 & 47\%&792 & 40\%&5958 & 25\%&216834 & 25\%&225585 \\
    just friend & 21\%&23314 & 40\%&910 & 42\%&1884 & 21\%&212969 & 21\%&239007 \\
    just mentioned & 18\%&182978 & 36\%&4721 & & 0 & & 0 & 18\%&187699 \\
\end{tabular}
\caption{
If target users interact with their contacts, then they are more likely to
live nearby.
%
In this table, ``I'' refers to the target user. ``You'' refers to their
contact.
%
}
\label{tab:ComTypes}
\end{table*}

\subsection{Are users closer to people they communicate with?}

We look at the 100 most recent tweets for the targets and one of their
contacts for each type of their contacts.
%
The edges are divided into groups based on whether the target user
mentioned the contact and whether the contact mentioned the target user.
%
For each of the groups, we calculate the percentage of contacts who
live within 25 miles of the targets and the number of edges in that group.
%
This is shown in Table~\ref{tab:ComTypes}.
%
Since contacts who were just mentioned were mentioned by the target
user by definition, the contact mentions and both ignore table cells are
empty.

In almost every case, increased communication increases the probability that
two users live near each other.
%
There is one exception: when an average user mentions someone they follow who
does not follow them back, it has no effect---in both cases the contact is
local 25\% of the time.
%
In other words, if a random user mentions a celebrity who does not bother to
reply, they probably do not live in the same area.
%
On the other hand, in the rare event that someone who is just a friend replies
to their follower, then the probability that they live near each other is much
higher---it goes from 21\% to 42\%.

The weakest type of contact is users who were just mentioned, but never
replied to.
%
If the person is mentioned, then 36\% of users with no
friend/follow relationship who have a conversation live within 25 miles.
%
This is approximately equal to the 35\% of reciprocal friends who ignore each
other and live within 25 miles.
%
Unsurprisingly, the strongest type of connection is reciprocal friends who
communicate.
%
One challenge to using communication patterns as a source of information for
location prediction is that the communication patterns that are correlated
with proximity are rare.

\begin{table}[tbh]
\centering
\begin{tabular}{l | r r | r r}
    & \multicolumn{2}{c}{Public}
    & \multicolumn{2}{|c}{Private} \\
    \cline{2-5}
    &local&count&local&count \\
    \hline
    Recip Friend & 37\%&211136 & 41\%&24873 \\
    Just Follower & 25\%&204417 & 31\%&21168 \\
    Just Friend & 21\%&233849 & 39\%&5228 \\
    Just Mentioned & 18\%&183368 & 35\%&4331 \\
\end{tabular}
\caption{
    Comparison between public accounts and private accounts on Twitter.
    Private accounts tend to be closer.
}
\label{tab:EdgeTypesProt}
\end{table}

\subsection{Are users closer to private accounts?}

Like many social networks, Twitter allows users to control the privacy settings
on their account.
%
The specifics differ from network to network, but in Twitter's case
a user can make their account private which means followers have to get
permission to follow the account.
%
There are demographic differences between public and protected accounts.
%
For example, Gilbert \cite{gilbert2008network} demonstrates that rural users
are more likely to make their accounts private than public accounts.
%
In the case of protected accounts on Twitter, basic information
about their profile such as their location and the number of friends and
followers is public, but their friends list, followers list, and the text of
their tweets is private, and not available for analysis.

As seen in Table~\ref{tab:EdgeTypesProt}, the most dramatic difference between
private and public occurs if a user follows a protected account.
%
Since users generally only allow people they know to follow a protected
account, this brings the users almost as close together as if they were
reciprocal friends.
%
On the other hand, if a protected account follows the target user, they
are only slightly more likely to be nearby.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/near_triads.pdf}
\caption{
Comparison between distance to a mutual friend, labeled ``our'', and someone
who is not a mutual friend, labeled ``my''.
If two contacts are mutual friends and live near each other, a target user is
more likely to live near them than two contacts who live nearby but are not
mutual friends.
}
\label{fig:NearTriads}
\end{figure}

\subsection{If two of your friends live near each other, does that increase the
chance that they live near you?}

In this section, we turn our attention to triangles of users.
Finding useful relationships between the edges of a social triangle is tricky
because the three distances depend on each other.
Unfortunately, it is fairly simple to show using the triangle inequality theorem
that if two users are 1000 miles apart, then the third member of the triangle
has to be at least 500 miles from one of the other two.
Since this isn't a useful result, we designed a more complex experiment to
analyze the relationship between the sides of the triangle.
A script searched for a specific pattern in the social network of
the target user's reciprocal friends: two people who were friends with each
other and a third person who had no connection with the other two:

\begin{center}
\includegraphics[width=0.3\linewidth]{figures/near_triads_dia.pdf}
\end{center}

To help label the four users, we describe this social graph from the
perspective of the target user:

\begin{itemize}
\item ``me'' is the target user
\item ``you'' is the contact who is reciprocal friends with ``me''
\item ``my'' has no relationship with ``you'' and is reciprocal friends with ``me''
\item ``our'' is reciprocal friends with both ``me'' and ``you''
\end{itemize}

We found this pattern for 147,669 of the target users.
%
If a user had multiple instances of this pattern, it picked one of them
randomly so that particular users would not bias the results.
%
%Since our crawler only retrieved friend and follower information for a few
%reciprocal friends per user, it is reasonable to assume that this pattern
%is more common, but the sample is more than enough data to draw some
%conclusions.
%
Figure~\ref{fig:NearTriads} shows a comparison between distances to the ``my''
users and the ``our'' users.
%
For each of the ``my'' users and the ``our'' users, we put them into one of
four logarithmically scaled bins based on their distance from the ``you'' user.
%
Then we plot the CDF for the distance from the target to the ``my'' and ``our'' users.
%
This allows us to investigate the effect of mutual friendship on distance.
We report one very simple result: if two of your friends are close (within 10
miles), then whether they know each other or not strongly affects how close
you are to them.
%
If they are farther apart, it doesn't matter.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/locals_10.pdf}
\caption{
The colored lines show the distance to contacts split into groups based on the
proportion of the contact's friends and followers who live near the contact.
The dotted line shows the distance to contacts who have no locatable contacts.
This graph is based on at most 10 leafs per contact.
Contacts who have a high proportion of nearby leafs are much more likely to
live near the target user.
}
\label{fig:Local10}
\end{figure}

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/locals_cmp.pdf}
\caption{
    Distances to contacts with a local contact ratio better than the median LCR
    for several numbers of leafs.
    Although looking at more leafs makes users with a high LCR more likely to
    be nearby, it probably doesn't justify how long it takes to compute.
}
\label{fig:LocalCmp}
\end{figure}

\subsection{Are some users closer to all of their friends and followers?}
\label{sec:closer}

In the previous sections we only looked at the contacts of the target
users.
%
In this section we will go two steps out on the social graph and
investigate the friends-of-friends.
%
We want to know if some users are more localized than others, so we compare
contacts with lots of local contacts to contacts with mostly distant contacts.
%
\textbf{Local Contact Ratio}(LCR) is the fraction of a user's contacts
who live near the user.
%
For a contact at location $l^c$ and a set of their contacts' locations L, we
formally define LCR as follows:
\[
    LCR(l^c,L) = { |\{ l_i \in L : |l_i-l^c|<25 \}|
                    \over |L| }
\]
%
We picked a cutoff distance of 25 miles to distinguish between local and non-local
contacts.
25 miles is about the distance where the bulk of local users ends as seen in
Figure~\ref{fig:EdgeCounts}.
%
The distance cutoff is somewhat arbitrary, but it doesn't seem to matter much
in practice since we are really trying to distinguish between contacts who are
hundreds of miles away and contacts who live in the same town.
%
Around one in ten contacts did not have any contacts with a location from the
contacts we looked at--they were treated as a separate group.

In \cite{li2012towards}, the authors model the probability distribution of
user's followers using a Gaussian distribution, and use this to build a
location prediction system.
%
There are many other ways to analyze the leafs: average distance to the leafs,
median distance to the leafs, fitting the distances to a curve such as a
Gaussian.
%
We are looking at location prediction anywhere in the world, which means
contacts may be 10,000 miles away, and a location 10,000 miles away is nearly
as bad as a location 1000 miles away, so average is obviously not useful.
%
The disadvantage to using the median is more subtle.
%
As seen in Figure~\ref{fig:EdgeTypesCuml}, the median distance to a contact is
often in the 100--1000 mile range, and only about a third of contacts are
actually local.
%
This means that median distance to leafs does a reasonable job of separating the
worst contacts from the average contacts, but local contact ratio does a better
job of identifying the very best contacts.

The figure shows that some users are much more local than other users.
For example, a local newspaper may have thousands of followers and few friends,
but the people who follow a newspaper are generally local.
According to the other factors we looked at, the newspaper is a bad predictor
of location, but in reality it is a great predictor.

Of the factors we have investigated, this is the one that is most strongly
correlated with distance---in the next section we will see that local contact
ratio ends up at the top of a decision tree to separate local contacts from
non-local contacts.
%
One problem with this technique is that it is somewhat expensive to deal with
the large number of profiles two steps out on the social graph.
%
Our crawler originally looked at 100 leafs per contact because Twitter's API
will return up to 100 profiles at a time, but fetching and saving all those
profiles is slow.
%
In Figure~\ref{fig:LocalCmp}, we compare contacts with a high LCR calculated
using at most 100 leafs per contact to at most 10 leafs per contact.
%
The percentage of contacts within 25 miles with a good LCR based on 10 leafs,
20 leafs, and 100 leafs was 53\%, 55\%, and 58\%, respectively.
%
All of these are noticeably closer than reciprocal friends who are within 25
miles 38\% of the time.

\section{Location Prediction}

Based on the questions we answered in the previous section, we have enough
information to build a system for location prediction, which we call
FriendlyLocation.
%
Since the location prediction system will be run on a large number of users,
it must be fast and scalable.
%
In Chapter~\ref{chap:eval} we will evaluate this system using five-fold cross
validation.
%
In this chapter we will use the numbers from one of the five folds to make
the descriptions more concrete.

\subsection{Edge Length Prediction}

We need to separate the best contacts, who are likely to be nearby, from
bad contacts who are likely to be far away.
%
The factors that we investigated in the previous section indicate when someone
is likely to be nearby, but they don't guarantee it.
%
There are pairs of users who are reciprocal friends with a small number of
followers, a high local friend ratio, have conversations, and still live on
opposite sides of the globe.
%
Another problem with this data is that some of these factors are correlated
with each other; users with lots of followers tend to have a low friend contact
ratio.
%
Finally, distant accounts like celebrities may be useless for determining which
city a person is from, but they might still suggest the user's home country.

In \cite{backstrom2010find}, the authors present a model of the relationship
between distance and friendship that treats all of the edges the same.
%
We can improve the accuracy of this model by weighting some edges more strongly
than others.
%
We have several pieces of information, and want to map it to a single, extremely
noisy value: the distance to a contact.
%
This could be looked at as a classification problem where you want to classify
edges as local or non-local, but the problem is there is a smooth continuum
from local to non-local, and semi-local friends can be useful for location
prediction.
%
As a result, we model this as a regression problem.
%
Since most of the input features are correlated and either binary or non-linear,
linear regression is unlikely to work well.
%
In addition, the data is dense and low-dimensional, so Support Vector Machines
do not work well.
%
We chose to use a decision tree regressor based on the CART algorithm
(classification and regression trees) to distinguish the best edges from the
worst.
%
A decision tree regressor works similar to the well-known decision tree
classifier, except that it produces real numbers as output instead of discrete
classes.
%
During training, the training data is recursively split based on the input
variable with the most predictive power to build a binary tree.
%
Each of the internal nodes of this tree have a cutoff for one of the input
variables, and the leaves of the tree have a predicted value.
%
%\jam{Does this need a better explanation? Can we assume people know decisiontrees?}

The regression tree was trained on several of the features from the previous
section that are correlated with users living near each other:
\begin{itemize}
\item the type of contact---reciprocal friendships tend to be physically closer than contacts with less strong relationships such as someone who is just a follower.
\item if the target mentioned the contact---Contacts who talk to the target user on Twitter tend to be located nearby.
\item if the contact mentioned the target---this is also true in the other direction.
\item if the contact had a protected account---protected accounts tend to be closer . We also have less information to give to the tree regressor for protected accounts than public accounts.
\item the contact's follower and friend count---contacts with lots of friends and followers tend to be celebrities or news organizations who tend to be further away.
\item the PLE of the contact's location---contacts with more precise locations are more useful for location prediction.
\item the contact's local contact ratio---some people have lots of friends who are close by, and other people have friends who are far apart.\end{itemize}
%
Since the distances between users varied by several orders of magnitude, we
trained the regressor to predict the log of the distance.
%
The tree regressor was configured to not split leafs with fewer than 1000 data
points to prevent over-fitting.
%
The top three levels of a decision tree are shown in Figure~\ref{fig:TreeTop}.
%
The predictor does not do a great job of predicting the actual distance to a
contact; there's simply too much noise.
%
However, it does do an excellent job of separating the closest pairs of users
from the most distant pairs as we will show in the next section.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/tree_top.pdf}
\caption{
    The top three levels of the decision tree. This decision tree will predict a
    distance of 839 miles for a contact with a local contact ratio of .2 and
    2800 friends. It will predict a much-closer distance of 43.7 miles for a
    user with a local contact ratio of .5 and a predicted location error of 10
    miles.
}
\label{fig:TreeTop}
\end{figure}



\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/terms.pdf}
\caption{ADD CAPTION}
\label{fig:NEWFIG}
\end{figure}


\subsection{Model}
\label{sec:model}

In the previous sections, we looked at the probability that a contact lives a
certain distance from a given user.
%
In this section, we build a model for the probability that a user, who we refer
to as the target user, lives at a specific location given the approximate
location of his contacts.
%
We will extend the model presented in \cite{backstrom2010find}.
%
Here's how they described their curve for the probability of friendship as a
function of distance:
\begin{quote}
To generate this curve, we aggregate over all individuals, computing the
distance between all $8.1 \times 10^{12}$ pairs of individuals with known
addresses.
We then bucket by intervals of 0.1 miles to compute the total number of pairs
and the number of pairs for which an edge is present, plotting the ratio. It
turns out that we can get a good fit to a curve of the form $a(b+x)^{-c}$.
The exponent very close to $c=-1$ suggests that, at medium to long-range
distances, the probability of friendship is roughly inversely proportional to
distance.
\end{quote}

There are several differences between what they did and what we are doing.
%
First, the data we have is from around the world, so we consider distances up
to 10,000 miles apart instead of stopping at 1,000 miles.
%
The data is a lot noisier in the 1,000--10,000 mile range because of the
distribution of land and oceans on the earth.
%
Next, their dataset had street addresses for approximately 2.9 million
Americans, and they used the friendships between users with street addresses to
do the calculation.
%
Since our geolocated users rarely have connections with other geolocated users
we use the geocoded locations of their contacts, which are less accurate than
street addresses since the locations are usually city names.
%
Finally, the most important difference is that we are not treating all the
edges like they are the same, so we can't fit just one curve.

Location prediction with a maximum likelihood estimator requires an estimate of
the probability that a user lives at a specific location.
%
We can find that probability by comparing the distribution of Twitter users to
the distribution of the contacts.
%
First, we needed a model for the density of Twitter users.
%
We calculate the distance between every target user and every contact
(even for contacts and users who had no relationship).
%
We call the number of target and contact pairs that are $d$ miles apart
$\edges(d)$.

% i index in R, decision tree tuples
% j index in Q, quantile boundaries
% k index in 

Next, we need to model the probability that two users are contacts.
%
We ran the decision tree regressor on the training data to create a set of
tuples $R = (d^a_i, d^p_i)$ for $d^a_i \in D^a$ and $d^p_i \in D^p$ where
$d^a_i$ is the actual length of the edge, and $d^p_i$ is the value predicted by
the decision tree.
%
We split $R$ into $m$ quantiles on the boundaries $\{q_0,\dots,q_m\}$ as
follows:\footnote{The notation used for order statistic may need some
explanation.  $X_{(n)}$ is the $n^{th}$ element in the set $X$ when sorted in
increasing order, so $X_{(2)}$ means the second smallest element in $X$.}

\[
    q_j =
    \begin{cases}
        D^p_{(1+\lfloor j|R|/m \rfloor)}, & j=<m \\
        \infty & j=m
    \end{cases}
\]


The quantile for a specific predicted distance $d^p_i$ can be found by
comparing it to the boundaries:
\[
    \quantile(d^p_i) = \max_{j \in \{0,\dots,m\}} \{j: d^p<q_j\}
\]

This lets us find $\contactEdges$, which is the number of users who fit in a
quantile $j$ and had an actual distance of $d$
\[
    \contactEdges(j,d) = |\{
            (d^a_i,d^p_i) \in R :
            d=d^a_i \wedge j=\quantile(d^p_i)
        \}|
\]

By comparing the number of edges that could have existed to the number of edges
that actually exist at a specific distance and in a specific quantile, we can
find the probability that a contact at a specific distance is in a quantile:

\[
\pContact(j,d) = \frac{\contactEdges(j,d)}{\edges(d)}
\]

For each of the quantiles, we can fit $\pContact$ to the curve from
\cite{backstrom2010find}:
\[
    \pContact(j,d) = a_{j} (b_{j}+d)^{-c_{j}}
\]

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/near_prob_fit.pdf}
\caption{
After splitting edges into groups based on their predicted distance, each group
was fit to a curve. Here are four of the ten curves and their curves of best
fit. The other six curves of best fit are shown as faint dotted lines. The
decision tree does a reasonable job of separating the best edges from the worst
edges.
}
\label{fig:NearProbFit}
\end{figure}

We choose to split into ten quantiles, which gave us ten different curves for the
probability that a certain type of contact exists between a pair of users.
%
Four of the ten curves from one of the folds from the five-fold evaluation and
their lines of best fit are shown in Figure~\ref{fig:NearProbFit}.
%
The best contacts are orders of magnitude more
likely to live near a target user than the worst contacts.
%
If the predictions from the tree regressor were ignored, and users were placed
into one group instead of ten equal groups, this would reduce to the model
for friendship and distance presented in \cite{backstrom2010find}.
%
We choose ten because it was large enough to distinguish between the curves.
%
Larger numbers of quantiles give no benefit since the curves we are
fitting are so noisy as can be seen in Figure~\ref{fig:NearProbFit}.

\begin{figure}[tbh]
\centering
\includegraphics[width=\linewidth]{figures/stranger_mat.png}
\caption{
    This is the probability that a user lives at a location based on the people
    who they have no contact with. Dark areas have lower probability, and light
    areas have a higher probability.
%
%\jam{Do we even need to show this graph? It's not new research, but I think it does help the reader understand $\pStrangers$.}
}
\label{fig:StrangerMat}
\end{figure}


\subsection{Location Prediction System}
We used this model to improve a maximum-likelihood estimator proposed by
Backstrom et al. in \cite{backstrom2010find}.
%
The predictor they propose expressed in our notation is
\[
    \Backstrom(l,L^c) = 
        \prod_{l^c \in L^c} {\p(|l-l^c|) \over 1-\p(l-l^c) }
        \prod_{l^s \in L^s} 1-\p(|l-l^s|)
\]
where $L^c$ is the set of locations of a user's contacts, $L^s$ is the set
of all strangers' locations, and $\p$ is the probability of friendship given
distance.

The last product in that formula is only a function of the location $l^c_i$ and
the locations of the strangers; it does not depend on any other information
about the target user's contacts.
%
As suggested in \cite{backstrom2010find}, this can be pre-computed for every
location.
%
For convenience, we refer to this as $\pStrangers$:
\[
    \pStrangers(l) = \prod_{l^s \in L^s}1-p(|l-l^s|)
\]
Figure~\ref{fig:StrangerMat} shows $\pStrangers$ for every location on earth.
%
Major cities have the lowest probability for $\pStrangers$.
%
It may seem counter-intuitive that areas with low population density have a
higher probability, but consider this example: if someone has ten friends in
New York City and ten friends in a small town in upstate New York, they are
more likely to live in the small town, and just happen to know people in the
big city.

We propose improving their system by adding in information from the decision
tree.
%
We do this by replacing the probability of being a contact based purely on
distance ($p$) to the probability we found in the previous section
($\pContact$).
%
We now have a formula for predicting the best location given $L$, the set of
locations of the contacts, and $P$, the set of predicted distances to the same
contacts:
\[
    \FriendLoc(l,L,P) =
        \left(
            \prod_{l^c_k \in L,p_k \in P}
            {\pContact(\quantile(p_k),|l-l^c_k|) \over (1-p(|l-l^c_k|))}
        \right)
        \pStrangers(l)
\]

Algorithm~\ref{alg:friendloc} shows all the pieces from this section and the
previous section tied together.



%\jam{locations of contacts are not independent as seen in~\ref{sec:closer}, but this formula really assumes they are. Where do we want to talk about this?}





{\small	
\bibliographystyle{aaai}
\bibliography{www}
}
\end{document}

\begin{algorithm}
  %\label{alg:friendloc}
  \caption{FriendlyLocation \label{alg:friendloc}}
  \begin{algorithmic}[0]
  \Input{The contacts $\contacts$}
  \Output{The predicted location}
  \State locations = list()
  \State predictedDists = list()
  \ForEach{contact \textbf{in} contacts}
      \If{contact.location \textbf{is} None}
        \State \Continue
      \EndIf
      \State locations.append(contact.location)
      \State dist = regressionTree.predict(contact.features)
      \State predictedDists.append(dist)
  \EndFor
  \State best = argmax(FriendLoc(locations,predictedDists))
  \State \Return locations[best]
  \end{algorithmic}
\end{algorithm}